<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Freight Estimator</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script>
    function autoSubmit(){ document.getElementById('mainForm').submit(); }
    function toggleCustom() {
      const cb = document.getElementById('use_custom');
      const city = document.getElementById('custom_city');
      const dest = document.getElementById('destination');
      if (cb.checked) {
        city.disabled = false; city.required = true;
        dest.disabled = true;  dest.required = false;
      } else {
        city.disabled = true;  city.required = false;
        dest.disabled = false; dest.required = true;
      }
    }
    window.addEventListener('DOMContentLoaded', toggleCustom);
  </script>
</head>
<body>
  <div class="map-wrap">{{ map_html|safe }}</div>

  <div class="panel">
    <h1>Freight Estimator</h1>
    <form id="mainForm" method="POST">
      <div class="row">
        <label>Shipment Type</label>
        <select name="shipment_type" onchange="autoSubmit()">
          {% for t in shipment_types %}
            <option value="{{ t }}" {% if t == selected_type %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="row">
        <label>Origin</label>
        <select name="origin" onchange="autoSubmit()" required>
          {% for o in origins %}
            <option value="{{ o }}" {% if o == selected_origin %}selected{% endif %}>{{ o }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="row">
        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="use_custom" name="use_custom" onchange="toggleCustom()" {% if use_custom %}checked{% endif %}>
          Use unknown destination
        </label>
      </div>

      <div class="row">
        <label>Destination (quoted lanes)</label>
        <select id="destination" name="destination" {% if use_custom %}disabled{% endif %} {% if not use_custom %}required{% endif %}>
          {% if destinations|length == 0 %}
            <option value="">-- no destinations for this origin --</option>
          {% else %}
            {% for d in destinations %}
              <option value="{{ d }}" {% if d == selected_destination %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>

      <div class="row">
        <label>Unknown Destination City</label>
        <input type="text" id="custom_city" name="custom_city" placeholder="e.g., Denver, CO" value="{{ custom_city }}" {% if not use_custom %}disabled{% endif %} {% if use_custom %}required{% endif %}>
      </div>

      <button type="submit">Estimate</button>
    </form>

    {% if quote %}
      <div class="result">
        {% if quote.error %}
          <p><strong>{{ quote.error }}</strong></p>
        {% else %}
          <p><strong>{{ quote.shipment_type }}</strong> — {% if quote.mode == 'quoted' %}Quoted Lane{% else %}Estimated (per‑mile){% endif %}</p>
          <p>{{ quote.origin }} → {{ quote.destination }}</p>
          {% if quote.distance_miles %}<p>{{ quote.distance_miles }} mi</p>{% endif %}
          {% if quote.mode == 'estimated' and quote.rate_per_mile %}<p>@ ${{ '%.4f'|format(quote.rate_per_mile) }} / mi</p>{% endif %}
          <p><strong>${{ '%.2f'|format(quote.average_total) }}</strong></p>
        {% endif %}
      </div>
    {% endif %}
  </div>
</body>
</html>
